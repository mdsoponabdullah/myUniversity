import React, { useState, useEffect } from 'react';
import { Search, Book, MessageSquare, Loader2 } from 'lucide-react';

// Sample university FAQ data - you can expand this
const FAQ_DATA = [
  {
    id: 1,
    question: "What are the admission requirements?",
    answer: "Admission requirements include a high school diploma with minimum GPA of 3.0, SAT scores (minimum 1200), letters of recommendation, personal statement, and application fee. International students need TOEFL/IELTS scores.",
    category: "Admissions"
  },
  {
    id: 2,
    question: "What is the tuition fee?",
    answer: "Undergraduate tuition is $15,000 per year for in-state students and $28,000 for out-of-state students. Graduate programs range from $18,000-$35,000 depending on the program. Financial aid and scholarships are available.",
    category: "Finance"
  },
  {
    id: 3,
    question: "What scholarships are available?",
    answer: "We offer merit-based scholarships ($5,000-$20,000), need-based grants, athletic scholarships, and departmental awards. Apply through the financial aid portal by March 1st for priority consideration.",
    category: "Finance"
  },
  {
    id: 4,
    question: "How do I apply for housing?",
    answer: "Housing applications open in February. Log into the student portal, complete the housing preference form, and pay the $200 deposit. Freshmen are guaranteed on-campus housing. Options include dorms, apartments, and themed living communities.",
    category: "Campus Life"
  },
  {
    id: 5,
    question: "What dining options are available?",
    answer: "Campus offers 5 dining halls, 8 cafes, and food courts. Meal plans range from 10-21 meals per week. Dietary accommodations include vegetarian, vegan, halal, kosher, and allergen-free options.",
    category: "Campus Life"
  },
  {
    id: 6,
    question: "What academic programs do you offer?",
    answer: "We offer over 100 undergraduate majors across Arts & Sciences, Engineering, Business, Education, and Health Sciences. Graduate programs include 60+ master's degrees and 30+ doctoral programs.",
    category: "Academics"
  },
  {
    id: 7,
    question: "What is the student-faculty ratio?",
    answer: "Our student-faculty ratio is 15:1, ensuring personalized attention. Average class size is 25 students for undergraduate courses and 12 for graduate seminars.",
    category: "Academics"
  },
  {
    id: 8,
    question: "Are there study abroad opportunities?",
    answer: "Yes! We partner with 50+ universities worldwide. Programs range from summer sessions to full-year exchanges. Popular destinations include Spain, Japan, UK, Australia, and Germany. Financial aid applies to approved programs.",
    category: "Academics"
  },
  {
    id: 9,
    question: "What career services are available?",
    answer: "Career Services offers resume reviews, mock interviews, job fairs, internship placement, networking events, and career counseling. Alumni mentorship program connects students with professionals in their field.",
    category: "Career"
  },
  {
    id: 10,
    question: "What is campus safety like?",
    answer: "Campus has 24/7 security, emergency blue light phones, escort services, and campus police. We offer safety apps, self-defense classes, and crime prevention programs. Annual security report available online.",
    category: "Campus Life"
  }
];

// Simple text similarity function (cosine similarity on word frequency)
function calculateSimilarity(query, text) {
  const queryWords = query.toLowerCase().split(/\s+/);
  const textWords = text.toLowerCase().split(/\s+/);
  
  let matches = 0;
  queryWords.forEach(word => {
    if (textWords.includes(word)) matches++;
  });
  
  return matches / Math.max(queryWords.length, 1);
}

// RAG retrieval function
function retrieveRelevantDocs(query, topK = 3) {
  const scoredDocs = FAQ_DATA.map(doc => {
    const questionScore = calculateSimilarity(query, doc.question);
    const answerScore = calculateSimilarity(query, doc.answer) * 0.7;
    const categoryScore = calculateSimilarity(query, doc.category) * 0.5;
    
    return {
      ...doc,
      score: questionScore + answerScore + categoryScore
    };
  });
  
  return scoredDocs
    .sort((a, b) => b.score - a.score)
    .slice(0, topK)
    .filter(doc => doc.score > 0);
}

// Simple response generation
function generateResponse(query, relevantDocs) {
  if (relevantDocs.length === 0) {
    return "I couldn't find specific information about that. Please try rephrasing your question or contact our admissions office at admissions@university.edu";
  }
  
  if (relevantDocs.length === 1) {
    return relevantDocs[0].answer;
  }
  
  let response = "Here's what I found:\n\n";
  relevantDocs.forEach((doc, idx) => {
    response += `${idx + 1}. ${doc.answer}\n\n`;
  });
  
  return response.trim();
}

export default function UniversityFAQ() {
  const [query, setQuery] = useState('');
  const [response, setResponse] = useState('');
  const [relevantDocs, setRelevantDocs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [chatHistory, setChatHistory] = useState([]);

  const handleSearch = () => {
    if (!query.trim()) return;
    
    setLoading(true);
    
    // Simulate processing delay
    setTimeout(() => {
      const docs = retrieveRelevantDocs(query);
      const answer = generateResponse(query, docs);
      
      setRelevantDocs(docs);
      setResponse(answer);
      
      setChatHistory(prev => [...prev, {
        question: query,
        answer: answer,
        timestamp: new Date()
      }]);
      
      setLoading(false);
    }, 500);
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleSearch();
    }
  };

  const categories = [...new Set(FAQ_DATA.map(faq => faq.category))];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8 pt-8">
          <div className="flex items-center justify-center mb-4">
            <Book className="w-12 h-12 text-indigo-600 mr-3" />
            <h1 className="text-4xl font-bold text-gray-800">University FAQ Assistant</h1>
          </div>
          <p className="text-gray-600">Ask me anything about admissions, programs, campus life, and more!</p>
        </div>

        {/* Search Box */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex gap-2">
            <input
              type="text"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="Ask a question... (e.g., 'What are the admission requirements?')"
              className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <button
              onClick={handleSearch}
              disabled={loading}
              className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 flex items-center gap-2 transition-colors"
            >
              {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}
              Search
            </button>
          </div>
        </div>

        {/* Quick Categories */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h3 className="text-lg font-semibold mb-3 text-gray-700">Quick Categories</h3>
          <div className="flex flex-wrap gap-2">
            {categories.map(cat => (
              <button
                key={cat}
                onClick={() => setQuery(cat)}
                className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition-colors"
              >
                {cat}
              </button>
            ))}
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Response Area */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="flex items-center mb-4">
              <MessageSquare className="w-6 h-6 text-indigo-600 mr-2" />
              <h2 className="text-xl font-semibold text-gray-800">Answer</h2>
            </div>
            
            {response ? (
              <div className="bg-gray-50 p-4 rounded-lg">
                <p className="text-gray-700 whitespace-pre-line">{response}</p>
              </div>
            ) : (
              <div className="text-gray-400 text-center py-8">
                <MessageSquare className="w-16 h-16 mx-auto mb-3 opacity-50" />
                <p>Ask a question to get started</p>
              </div>
            )}

            {relevantDocs.length > 0 && (
              <div className="mt-4">
                <p className="text-sm text-gray-500">
                  Retrieved {relevantDocs.length} relevant document(s)
                </p>
              </div>
            )}
          </div>

          {/* Chat History */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">Recent Questions</h2>
            
            {chatHistory.length > 0 ? (
              <div className="space-y-4 max-h-96 overflow-y-auto">
                {chatHistory.slice().reverse().map((chat, idx) => (
                  <div key={idx} className="border-l-4 border-indigo-500 pl-4 py-2">
                    <p className="font-medium text-gray-800 mb-1">Q: {chat.question}</p>
                    <p className="text-sm text-gray-600 line-clamp-2">A: {chat.answer}</p>
                    <p className="text-xs text-gray-400 mt-1">
                      {chat.timestamp.toLocaleTimeString()}
                    </p>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-gray-400 text-center py-8">
                <p>Your question history will appear here</p>
              </div>
            )}
          </div>
        </div>

        {/* Sample Questions */}
        <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
          <h3 className="text-lg font-semibold mb-3 text-gray-700">Try These Questions</h3>
          <div className="grid md:grid-cols-2 gap-2">
            {FAQ_DATA.slice(0, 6).map(faq => (
              <button
                key={faq.id}
                onClick={() => setQuery(faq.question)}
                className="text-left px-4 py-2 bg-gray-50 hover:bg-indigo-50 rounded-lg text-sm text-gray-700 hover:text-indigo-700 transition-colors"
              >
                {faq.question}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}